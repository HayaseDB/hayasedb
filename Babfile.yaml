includes:
  api:
    babfile: ./api/babfiles/babfile.api.yaml
  web:
    babfile: ./web/babfiles/babfile.web.yaml

tasks:

  check:
    desc: useful for pre commit checks
    run:
      - task: api:check
      - task: web:check

  env:generate:
    desc: Generate .env file with interactive prompts
    run:
      - prompt: confirm_overwrite
        type: confirm
        message: ".env file already exists. Overwrite?"
        default: false

      - prompt: app_env
        type: select
        message: "Environment:"
        options: [development, staging, production]

      - log: "Production/Staging mode: Use strong secrets (min 32 chars)!"
        level: warn
        when: ${{ app_env }} != 'development'

      - prompt: deploy_mode
        type: select
        message: "Deployment mode:"
        options: [local, docker]

      - prompt: api_domain
        type: input
        message: "API domain (e.g., api.hayasedb.com):"
        default: "localhost"
        when: ${{ deploy_mode }} == 'docker'
      - prompt: web_domain
        type: input
        message: "Web domain (e.g., hayasedb.com):"
        default: "localhost"
        when: ${{ deploy_mode }} == 'docker'
      - prompt: minio_domain
        type: input
        message: "MinIO console domain (e.g., minio.hayasedb.com):"
        default: "localhost"
        when: ${{ deploy_mode }} == 'docker'

      - prompt: api_port
        type: input
        message: "API port:"
        default: "3000"
      - prompt: web_port
        type: input
        message: "Web port:"
        default: "8080"

      - prompt: db_name
        type: input
        message: "Database name:"
        default: "hayasedb"
      - prompt: db_user
        type: input
        message: "Database username:"
        default: "postgres"
      - prompt: db_pass
        type: input
        message: "Database password:"
        default: "postgres"
      - prompt: db_logging
        type: select
        message: "Enable database query logging?"
        options: [true, false]
        when: ${{ app_env }} == 'development'

      - prompt: jwt_secret
        type: input
        message: "JWT secret (min 32 chars):"
        default: "your-jwt-secret-min-32-chars"
      - prompt: jwt_refresh_secret
        type: input
        message: "JWT refresh secret (min 32 chars):"
        default: "your-refresh-secret-min-32-chars"

      - prompt: minio_access
        type: input
        message: "MinIO access key:"
        default: "minioadmin"
      - prompt: minio_secret
        type: input
        message: "MinIO secret key:"
        default: "minioadmin"

      - prompt: mail_provider
        type: select
        message: "Mail provider:"
        options: [smtp, resend]
      - prompt: mail_from_name
        type: input
        message: "Mail sender name:"
        default: "HayaseDB"
      - prompt: mail_from_address
        type: input
        message: "Mail sender address:"
        default: "noreply@hayasedb.com"

      - prompt: smtp_host
        type: input
        message: "SMTP host:"
        default: "localhost"
        when: ${{ mail_provider }} == 'smtp' && ${{ deploy_mode }} == 'local'
      - prompt: smtp_host
        type: input
        message: "SMTP host:"
        default: "mailpit"
        when: ${{ mail_provider }} == 'smtp' && ${{ deploy_mode }} == 'docker'
      - prompt: smtp_port
        type: input
        message: "SMTP port:"
        default: "1025"
        when: ${{ mail_provider }} == 'smtp'

      - prompt: resend_api_key
        type: input
        message: "Resend API key:"
        when: ${{ mail_provider }} == 'resend'

      - prompt: swagger_enabled
        type: select
        message: "Enable Swagger API docs?"
        options: [true, false]
        when: ${{ app_env }} != 'production'

      - prompt: web_session_password
        type: input
        message: "Web session password (min 32 chars):"
        default: "your-session-password-min-32-chars"

      - cmd: |
          cat > .env << 'ENVFILE'
          # GLOBAL
          APP_ENV=${{ app_env }}

          # API - Core
          API_ENV=${{ app_env }}
          API_PORT=${{ api_port }}
          ENVFILE

      - cmd: echo "API_WEB_URL=http://localhost:${{ web_port }}" >> .env
        when: ${{ deploy_mode }} == 'local'
      - cmd: echo "API_WEB_URL=https://${{ web_domain }}" >> .env
        when: ${{ deploy_mode }} == 'docker'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # API - Database
          ENVFILE

      - cmd: echo "API_DATABASE_HOST=localhost" >> .env
        when: ${{ deploy_mode }} == 'local'
      - cmd: echo "API_DATABASE_HOST=postgres" >> .env
        when: ${{ deploy_mode }} == 'docker'

      - cmd: |
          cat >> .env << 'ENVFILE'
          API_DATABASE_PORT=5432
          API_DATABASE_NAME=${{ db_name }}
          API_DATABASE_USERNAME=${{ db_user }}
          API_DATABASE_PASSWORD=${{ db_pass }}
          API_DATABASE_SYNCHRONIZE=false
          ENVFILE

      - cmd: echo "API_DATABASE_LOGGING=${{ db_logging }}" >> .env
        when: ${{ app_env }} == 'development'
      - cmd: echo "API_DATABASE_LOGGING=false" >> .env
        when: ${{ app_env }} != 'development'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # API - JWT Authentication
          API_JWT_SECRET=${{ jwt_secret }}
          API_JWT_EXPIRES_IN=1h
          API_JWT_REFRESH_SECRET=${{ jwt_refresh_secret }}
          API_JWT_REFRESH_EXPIRES_IN=7d

          # API - MinIO Storage
          ENVFILE

      - cmd: echo "API_MINIO_HOST=localhost" >> .env
        when: ${{ deploy_mode }} == 'local'
      - cmd: echo "API_MINIO_HOST=minio" >> .env
        when: ${{ deploy_mode }} == 'docker'

      - cmd: |
          cat >> .env << 'ENVFILE'
          API_MINIO_PORT=9000
          API_MINIO_ACCESS_KEY=${{ minio_access }}
          API_MINIO_SECRET_KEY=${{ minio_secret }}

          # API - Mail (Common)
          API_MAIL_PROVIDER=${{ mail_provider }}
          API_MAIL_FROM_NAME=${{ mail_from_name }}
          API_MAIL_FROM_ADDRESS=${{ mail_from_address }}
          API_MAIL_VERIFY_CONNECTION=false
          ENVFILE

      - cmd: |
          cat >> .env << 'ENVFILE'

          # API - SMTP (when API_MAIL_PROVIDER=smtp)
          API_SMTP_HOST=${{ smtp_host }}
          API_SMTP_PORT=${{ smtp_port }}
          ENVFILE
        when: ${{ mail_provider }} == 'smtp'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # API - Resend (when API_MAIL_PROVIDER=resend)
          API_RESEND_API_KEY=${{ resend_api_key }}
          ENVFILE
        when: ${{ mail_provider }} == 'resend'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # API - Swagger
          API_SWAGGER_ENABLED=${{ swagger_enabled }}
          API_SWAGGER_PATH=docs
          ENVFILE
        when: ${{ app_env }} != 'production'
      - cmd: |
          cat >> .env << 'ENVFILE'

          # API - Swagger
          API_SWAGGER_ENABLED=false
          API_SWAGGER_PATH=docs
          ENVFILE
        when: ${{ app_env }} == 'production'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # WEB
          WEB_PORT=${{ web_port }}
          ENVFILE

      - cmd: echo "WEB_API_URL=http://localhost:${{ api_port }}" >> .env
        when: ${{ deploy_mode }} == 'local'
      - cmd: echo "WEB_API_URL=https://${{ api_domain }}" >> .env
        when: ${{ deploy_mode }} == 'docker'

      - cmd: echo "WEB_SESSION_PASSWORD=${{ web_session_password }}" >> .env

      - cmd: |
          cat >> .env << 'ENVFILE'

          # DEPLOYMENT
          API_DOMAIN=${{ api_domain }}
          WEB_DOMAIN=${{ web_domain }}
          API_MINIO_CONSOLE_DOMAIN=${{ minio_domain }}
          ENVFILE
        when: ${{ deploy_mode }} == 'docker'

      - log: ".env file generated successfully!"
        level: info

  docker:infra:
    desc: Start infrastructure only (postgres + minio + mailpit)
    run:
      - cmd: docker compose up -d postgres minio mailpit

  docker:up:
    desc: Start all services
    run:
      - cmd: docker compose up -d

  docker:build:
    desc: Build and start all services
    run:
      - cmd: docker compose up -d --build

  docker:down:
    desc: Stop all services
    run:
      - cmd: docker compose down

  docker:destroy:
    desc: Stop all services and remove volumes
    run:
      - prompt: confirm
        type: confirm
        message: "This will remove all data. Continue?"
        default: false
      - cmd: docker compose down -v

  docker:logs:
    desc: Show logs from all services
    run:
      - cmd: docker compose logs -f

  docker:logs:api:
    desc: Show logs from API service
    run:
      - cmd: docker compose logs -f api

  docker:logs:db:
    desc: Show logs from PostgreSQL service
    run:
      - cmd: docker compose logs -f postgres

  docker:logs:mail:
    desc: Show logs from Mailpit service
    run:
      - cmd: docker compose logs -f mailpit

  docker:logs:minio:
    desc: Show logs from MinIO service
    run:
      - cmd: docker compose logs -f minio

  docker:status:
    desc: Show running services
    run:
      - cmd: docker compose ps

  docker:restart:
    desc: Restart all services
    run:
      - cmd: docker compose restart

  docker:rebuild:api:
    desc: Rebuild and restart API service
    run:
      - cmd: docker compose up -d --build api
