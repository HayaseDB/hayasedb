includes:
  api:
    babfile: ./api/babfiles/babfile.api.yaml
  web:
    babfile: ./web/babfiles/babfile.web.yaml

tasks:

  check:
    desc: useful for pre commit checks
    run:
      - task: api:check
      - task: web:check

  env:generate:
    desc: Generate .env file with interactive prompts
    run:
      - prompt: confirm_overwrite
        type: confirm
        message: ".env file already exists. Overwrite?"
        default: false

      - prompt: app_env
        type: select
        message: "Environment:"
        options: [development, staging, production]

      - log: "Production mode: Use strong secrets (min 32 chars)!"
        level: warn
        when: ${{ app_env }} == 'production'

      - prompt: api_port
        type: input
        message: "API port:"
        placeholder: "3000"
        default: "3000"
      - prompt: web_port
        type: input
        message: "Web port:"
        placeholder: "3001"
        default: "3001"

      - prompt: db_name
        type: input
        message: "Database name:"
        placeholder: "hayasedb"
        default: "hayasedb"
      - prompt: db_user
        type: input
        message: "Database username:"
        placeholder: "postgres"
        default: "postgres"
      - prompt: db_pass
        type: input
        message: "Database password:"
        placeholder: "postgres"
        default: "postgres"
      - prompt: db_logging
        type: select
        message: "Enable database query logging?"
        options: [true, false]
        when: ${{ app_env }} == 'development'

      - prompt: jwt_secret
        type: input
        message: "JWT secret (min 32 chars):"
        placeholder: "dev-jwt-secret-change-in-production"
        default: "dev-jwt-secret-change-in-production"
      - prompt: jwt_refresh_secret
        type: input
        message: "JWT refresh secret (min 32 chars):"
        placeholder: "dev-refresh-secret-change-in-production"
        default: "dev-refresh-secret-change-in-production"

      - prompt: swagger_enabled
        type: select
        message: "Enable Swagger API docs?"
        options: [true, false]
        when: ${{ app_env }} != 'production'

      - prompt: mail_provider
        type: select
        message: "Mail provider:"
        options: [smtp, resend]
      - prompt: mail_from_name
        type: input
        message: "Mail sender name:"
        placeholder: "HayaseDB"
        default: "HayaseDB"
      - prompt: mail_from_address
        type: input
        message: "Mail sender address:"
        placeholder: "noreply@localhost"
        default: "noreply@localhost"

      - prompt: smtp_host
        type: input
        message: "SMTP host:"
        placeholder: "localhost"
        default: "localhost"
        when: ${{ mail_provider }} == 'smtp'
      - prompt: smtp_port
        type: input
        message: "SMTP port:"
        placeholder: "1025"
        default: "1025"
        when: ${{ mail_provider }} == 'smtp'
      - prompt: smtp_secure
        type: select
        message: "SMTP secure (TLS)?"
        options: [false, true]
        when: ${{ mail_provider }} == 'smtp'
      - prompt: smtp_user
        type: input
        message: "SMTP username (optional):"
        placeholder: ""
        default: ""
        when: ${{ mail_provider }} == 'smtp'
      - prompt: smtp_pass
        type: input
        message: "SMTP password (optional):"
        placeholder: ""
        default: ""
        when: ${{ mail_provider }} == 'smtp'

      - prompt: resend_api_key
        type: input
        message: "Resend API key:"
        placeholder: "re_xxxxxxxxxxxx"
        default: ""
        when: ${{ mail_provider }} == 'resend'

      - prompt: minio_access
        type: input
        message: "MinIO access key:"
        placeholder: "minioadmin"
        default: "minioadmin"
      - prompt: minio_secret
        type: input
        message: "MinIO secret key:"
        placeholder: "minioadmin"
        default: "minioadmin"

      - cmd: |
          cat > .env << 'ENVFILE'
          # Generated by: bab env:generate
          # Environment: ${{ app_env }}

          # GLOBAL
          APP_ENV=${{ app_env }}

          # API
          API_PORT=${{ api_port }}
          API_WEB_URL=http://localhost:${{ web_port }}

          # Database
          API_DATABASE_NAME=${{ db_name }}
          API_DATABASE_USERNAME=${{ db_user }}
          API_DATABASE_PASSWORD=${{ db_pass }}
          API_DATABASE_PORT=5432
          ENVFILE

      - cmd: echo "API_DATABASE_LOGGING=${{ db_logging }}" >> .env
        when: ${{ app_env }} == 'development'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # Swagger
          API_SWAGGER_ENABLED=${{ swagger_enabled }}
          API_SWAGGER_PATH=docs
          ENVFILE
        when: ${{ app_env }} != 'production'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # Swagger
          API_SWAGGER_ENABLED=false
          API_SWAGGER_PATH=docs
          ENVFILE
        when: ${{ app_env }} == 'production'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # JWT
          API_JWT_SECRET=${{ jwt_secret }}
          API_JWT_EXPIRES_IN=1h
          API_JWT_REFRESH_SECRET=${{ jwt_refresh_secret }}
          API_JWT_REFRESH_EXPIRES_IN=7d

          # Mail
          API_MAIL_PROVIDER=${{ mail_provider }}
          API_MAIL_FROM_NAME=${{ mail_from_name }}
          API_MAIL_FROM_ADDRESS=${{ mail_from_address }}
          ENVFILE

      - cmd: |
          cat >> .env << 'ENVFILE'

          # SMTP
          API_SMTP_HOST=${{ smtp_host }}
          API_SMTP_PORT=${{ smtp_port }}
          API_SMTP_SECURE=${{ smtp_secure }}
          API_SMTP_USER=${{ smtp_user }}
          API_SMTP_PASS=${{ smtp_pass }}
          ENVFILE
        when: ${{ mail_provider }} == 'smtp'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # Resend
          API_RESEND_API_KEY=${{ resend_api_key }}
          ENVFILE
        when: ${{ mail_provider }} == 'resend'

      - cmd: |
          cat >> .env << 'ENVFILE'

          # MinIO
          API_MINIO_ACCESS_KEY=${{ minio_access }}
          API_MINIO_SECRET_KEY=${{ minio_secret }}
          API_MINIO_PORT=9000

          # WEB
          WEB_PORT=${{ web_port }}
          ENVFILE

      - log: ".env file generated successfully!"
        level: info

  docker:infra:
    desc: Start infrastructure only (postgres + minio + mailpit)
    run:
      - cmd: docker compose up -d postgres minio mailpit

  docker:up:
    desc: Start all services
    run:
      - cmd: docker compose up -d

  docker:build:
    desc: Build and start all services
    run:
      - cmd: docker compose up -d --build

  docker:down:
    desc: Stop all services
    run:
      - cmd: docker compose down

  docker:destroy:
    desc: Stop all services and remove volumes
    run:
      - prompt: confirm
        type: confirm
        message: "This will remove all data. Continue?"
        default: false
      - cmd: docker compose down -v

  docker:logs:
    desc: Show logs from all services
    run:
      - cmd: docker compose logs -f

  docker:logs:api:
    desc: Show logs from API service
    run:
      - cmd: docker compose logs -f api

  docker:logs:db:
    desc: Show logs from PostgreSQL service
    run:
      - cmd: docker compose logs -f postgres

  docker:logs:mail:
    desc: Show logs from Mailpit service
    run:
      - cmd: docker compose logs -f mailpit

  docker:logs:minio:
    desc: Show logs from MinIO service
    run:
      - cmd: docker compose logs -f minio

  docker:status:
    desc: Show running services
    run:
      - cmd: docker compose ps

  docker:restart:
    desc: Restart all services
    run:
      - cmd: docker compose restart

  docker:rebuild:api:
    desc: Rebuild and restart API service
    run:
      - cmd: docker compose up -d --build api
